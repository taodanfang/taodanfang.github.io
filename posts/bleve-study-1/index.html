<!DOCTYPE html>
<html lang="" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>全文搜索引擎库（Bleve）学习实践 &middot; CC-Table： 专注协同计算技术研发</title>
  <meta name="description" content="" />
  <link href="https://taodanfang.github.io/css/katex.css" rel="stylesheet">
  
  
  
  
  <link href="https://taodanfang.github.io/css/concated.min.css" rel="stylesheet">
  
  


</head>


  <body > 
    <div style="position: fixed; z-index: 500;
    width: 100vw; background-color: black; color: white;
    box-shadow: 0 0.4rem 2rem 0 rgba(0,0,0,0.2);">
        
<nav class="nav-bar side-padding" style="max-width: 100vw;"
>
  <h1 class="nav-header"><a href="https://taodanfang.github.io" 
    class="nav-text" style="color: wheat;">熙熙表格</a></h1>
 
  <h3 class="nav-header nav-text" 
  >
  <a href="#single-page-head" style="font-size: 18px; color:lightgreen; padding-top: 4px;">  全文搜索引擎库（Bleve）学习实践</a>

</h3>
  
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span  style="background-color: wheat;"></span>
      <span  style="background-color: wheat;"></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://taodanfang.github.io" class="hamburger-menu-overlay-link">Home</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/bleve/" class="hamburger-menu-overlay-link">bleve</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/boltdb/" class="hamburger-menu-overlay-link">boltdb</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/casbin/" class="hamburger-menu-overlay-link">casbin</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/cc-table/" class="hamburger-menu-overlay-link">cc-table</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/channel/" class="hamburger-menu-overlay-link">channel</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/context/" class="hamburger-menu-overlay-link">context</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/crdt/" class="hamburger-menu-overlay-link">CRDT</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/d2admin/" class="hamburger-menu-overlay-link">d2admin</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/deployment/" class="hamburger-menu-overlay-link">deployment</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/distributed-computing/" class="hamburger-menu-overlay-link">distributed computing</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/drag-and-drop/" class="hamburger-menu-overlay-link">drag and drop</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/event/" class="hamburger-menu-overlay-link">event</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/go/" class="hamburger-menu-overlay-link">go</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/golang/" class="hamburger-menu-overlay-link">golang</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/goroutine/" class="hamburger-menu-overlay-link">goroutine</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/iot/" class="hamburger-menu-overlay-link">iot</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/kit/" class="hamburger-menu-overlay-link">kit</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/math/" class="hamburger-menu-overlay-link">math</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/microservice/" class="hamburger-menu-overlay-link">microservice</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/mongodb/" class="hamburger-menu-overlay-link">mongodb</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/nats/" class="hamburger-menu-overlay-link">nats</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/page/" class="hamburger-menu-overlay-link">page</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/practice/" class="hamburger-menu-overlay-link">practice</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/pubsub/" class="hamburger-menu-overlay-link">pubsub</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/rule/" class="hamburger-menu-overlay-link">rule</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/schedule/" class="hamburger-menu-overlay-link">“schedule&#34;</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/search/" class="hamburger-menu-overlay-link">search</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/socket.io/" class="hamburger-menu-overlay-link">socket.io</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/task/" class="hamburger-menu-overlay-link">task</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/tenant/" class="hamburger-menu-overlay-link">tenant</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/tree/" class="hamburger-menu-overlay-link">tree</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/vue/" class="hamburger-menu-overlay-link">vue</a></li>
      
      <li><a href="https://taodanfang.github.io/categories/websocket/" class="hamburger-menu-overlay-link">websocket</a></li>
      
      
    </ul>
  </div>
</nav>



    </div>

    <div class="single-body">
      <main id="single-page-head" class="content side-text-padding" style="margin-top: 108px;">
        <article class="post dropcase">
          <header class="post-header">

            <h1 class="post-title" >全文搜索引擎库（Bleve）学习实践</h1>
            
            <div class="nav-bar">
              <p class="post-date">
                Posted 
                <time datetime="2021-12-16">Dec 16, 2021</time>
              </p>

              <div>
                <span style="font-size: 14px; padding-top: 0px;;"
                 id="busuanzi_container_site_uv">
                本站访客数
                <span style="padding-left: 4px; padding-right: 4px; color: red;"
                id="busuanzi_value_site_uv"></span> 人次, 
                </span>
                <span style="font-size: 14px; padding-bottom: 10px;;"
                id="busuanzi_container_page_pv">
                    本文总阅读量
                    <span style="padding-left: 4px; padding-right: 4px; color: red;"  
                    id="busuanzi_value_page_pv"></span> 次
                </span>
              </div>
            </div>
            
            

          </header>
          <picture class="post-figure">
            
            
            
            <source srcset="https://taodanfang.github.io/posts/bleve-study-1/media/16396295213776_hubaae0ff782c8b75f8b806f4834290463_239809_711x0_resize_q75_lanczos.jpg 1x, https://taodanfang.github.io/posts/bleve-study-1/media/16396295213776_hubaae0ff782c8b75f8b806f4834290463_239809_1422x0_resize_q75_lanczos.jpg 2x, https://taodanfang.github.io/posts/bleve-study-1/media/16396295213776_hubaae0ff782c8b75f8b806f4834290463_239809_2133x0_resize_q75_lanczos.jpg 3x">
            <img src="https://taodanfang.github.io/posts/bleve-study-1/media/16396295213776_hubaae0ff782c8b75f8b806f4834290463_239809_711x0_resize_q75_lanczos.jpg" >
          </picture>
          


          <div class="content-toc" style="min-width: 280px;" >
            <div style="margin-top: -20px;">
              <h2 style="margin-top: 10px;">目录</h2>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#原理分析">原理分析</a></li>
    <li><a href="#bleve-文档摘录">Bleve 文档摘录</a>
      <ul>
        <li><a href="#相关术语">相关术语</a></li>
        <li><a href="#重要接口">重要接口</a></li>
        <li><a href="#查询方法">查询方法</a></li>
        <li><a href="#结果排序">结果排序</a></li>
        <li><a href="#联合搜索">联合搜索</a></li>
        <li><a href="#facet聚合">Facet（聚合）</a></li>
      </ul>
    </li>
    <li><a href="#bleve-实践一">Bleve 实践一</a>
      <ul>
        <li><a href="#创建索引数据库">创建索引数据库</a></li>
      </ul>
    </li>
    <li><a href="#参考文献">参考文献</a></li>
  </ul>
</nav>
            </div>
          </div>

          <div class="next-post"  style="min-width: 250px;" >
            
            <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://taodanfang.github.io/posts/nats-io-2/" class="card blog-card bc-next" rel="bookmark" >

  <article class="card-body">
    <h2 class="card-title">NATS 开发文档摘录</h2>
    <p class="card-text">本文摘录了NATS官方文档中的重要部分。包括：基本的nats使用，支持持久化的jetstream的使用方法。
</p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2021-12-13 1213:00">Dec 13, 2021</time></p>
      <p>#golang #nats </p>
    </div>
  </article>
</a>
            
          </div>

          <p>Bleve is an open-sourced text indexing and search library implemented in Go, developed in-house at Couchbase.</p>
<p>You’ve probably heard of the most well-known Full-Text Search engine: Lucene with Elasticsearch built on top of it. Couchbase’s Full-Text Search (FTS) Engine is powered by Bleve, and this article will showcase the various ways to analyze text within this engine.</p>
<h2 id="简介">简介</h2>
<p>Bleve 是一个由 Couchbase 团队基于 Go 语言开发的索引 / 检索库，它支持常用的检索和索引功能，如索引、检索、过滤、排序、聚合、高亮等。Bleve 包括常见的文本分析组件，且能够使用现有的 K/V 存储系统进行存储。</p>
<p>Bleve 具有以下主要特性：</p>
<ul>
<li>支持所有 Go 数据结构的索引，如 JSON 、结构体、Slices、字符串等</li>
<li>具有强大、智能的配置功能</li>
<li>具有丰富的 Field 类型，如文本、数字、日期等</li>
<li>具有丰富查询类型，如 Term、短语、模糊 / 精确匹配、前缀、逻辑与（Conjunction）、逻辑或（Disjunction）、布尔（Boolean）、数字范围、日期范围等查询</li>
<li>具有简单的查询语法，且能够实现复杂的查询</li>
<li>具有丰富的接口，且能够实现功能扩展</li>
<li>具有易用且高级 API 能够索引数据模型中的任何对象</li>
<li>基于标准的 TF-IDF 加权评分算法</li>
<li>支持查询匹配结果的高亮显示</li>
<li>支持多种聚合功能 (Facet)，如能够根据 Term、数字范围、日期范围聚合等</li>
<li>文本解析组件现已支持众多分析组件，支持将近二十种语言，如丹麦语、荷兰语、英国、法语、德语、泰语、土耳其语等</li>
</ul>
<h2 id="原理分析">原理分析</h2>
<p>Bleve 搜索引擎的工作原理如下图：</p>
<p><img src="media/16396320406551.jpg" alt=""></p>
<p>With Couchbase’s Full-Text Search engine, the analyzers and all their components work on text that constitutes field values within JSON documents. They do not work on field names. （注意：JSON文本分析，仅针对JSON对象的value，不对key进行分析）</p>
<blockquote>
<p>Text Analyzer 组成</p>
</blockquote>
<p>An analyzer transforms input Text into a Token Stream. Analyzers are composed of one or more constituent pieces to form a pipeline. The pipe consists of zero or more Character Filters, followed by a single Tokenizer, followed by zero or more Token Filters. The input Text is run through this pipeline to produce the resulting Token Stream. 一个文本分析器有若干个组件构成，形成了一个管道。这个管道中，依次包括0或多个符号过滤器，一个分词器，0个或多个令牌过滤器。文本经过该管道的处理后，生成了一个令牌流。</p>
<p><img src="media/16396321214322.jpg" alt=""></p>
<blockquote>
<p>Tokenizer (分词器）</p>
</blockquote>
<p>A tokenizer is the first component to which the documents are subjected to. As the name suggests, it breaks the raw text into a list of tokens. This conversion will depend on a rule-set defined for the tokenizer. 包括如下分词器：</p>
<p><img src="media/16396322900110.jpg" alt=""></p>
<blockquote>
<p>Character Filter（符号过滤器）</p>
</blockquote>
<p>Character filters are to remove or replace undesirable characters.</p>
<p><img src="media/16396323621309.jpg" alt=""></p>
<blockquote>
<p>Token Filter（令牌过滤器）</p>
</blockquote>
<p>Token filters accept a token stream provided by a tokenizer and make modifications to the tokens in the stream.</p>
<p><img src="media/16396324311081.jpg" alt=""></p>
<blockquote>
<p>Language (支持的语言）</p>
</blockquote>
<p><img src="media/16396326613409.jpg" alt=""></p>
<p>注意：可以采用以上多个组件对文本进行分析，通过配置组件的顺序，可以获得不同的分析结果。</p>
<blockquote>
<p>中文处理插件</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#008000;font-weight:bold">package</span> bleve_jieba

<span style="color:#008000;font-weight:bold">import</span> (
	<span style="color:#ba2121">&#34;errors&#34;</span>

	<span style="color:#ba2121">&#34;github.com/blevesearch/bleve/v2/analysis&#34;</span>
	<span style="color:#ba2121">&#34;github.com/blevesearch/bleve/v2/mapping&#34;</span>
	<span style="color:#ba2121">&#34;github.com/blevesearch/bleve/v2/registry&#34;</span>
	<span style="color:#ba2121">&#34;github.com/yanyiwu/gojieba&#34;</span>
)

<span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">init</span>() {
	registry.<span style="color:#00f">RegisterAnalyzer</span>(<span style="color:#ba2121">&#34;gojieba&#34;</span>, analyzerConstructor)
	registry.<span style="color:#00f">RegisterTokenizer</span>(<span style="color:#ba2121">&#34;gojieba&#34;</span>, tokenizerConstructor)
}

<span style="color:#008000;font-weight:bold">type</span> JiebaAnalyzer <span style="color:#008000;font-weight:bold">struct</span> {
}

<span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">analyzerConstructor</span>(config <span style="color:#008000;font-weight:bold">map</span>[<span style="color:#b00040">string</span>]<span style="color:#008000;font-weight:bold">interface</span>{}, cache <span style="color:#666">*</span>registry.Cache) (<span style="color:#666">*</span>analysis.Analyzer, <span style="color:#b00040">error</span>) {
	tokenizerName, ok <span style="color:#666">:=</span> config[<span style="color:#ba2121">&#34;tokenizer&#34;</span>].(<span style="color:#b00040">string</span>)
	<span style="color:#008000;font-weight:bold">if</span> !ok {
		<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">nil</span>, errors.<span style="color:#00f">New</span>(<span style="color:#ba2121">&#34;must specify tokenizer&#34;</span>)
	}
	tokenizer, err <span style="color:#666">:=</span> cache.<span style="color:#00f">TokenizerNamed</span>(tokenizerName)
	<span style="color:#008000;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#008000;font-weight:bold">nil</span> {
		<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">nil</span>, err
	}
	alz <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>analysis.Analyzer{
		Tokenizer: tokenizer,
	}
	<span style="color:#008000;font-weight:bold">return</span> alz, <span style="color:#008000;font-weight:bold">nil</span>
}

<span style="color:#008000;font-weight:bold">type</span> JiebaTokenizer <span style="color:#008000;font-weight:bold">struct</span> {
	handle <span style="color:#666">*</span>gojieba.Jieba
}

<span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">NewJiebaTokenizer</span>(dictpath, hmmpath, userdictpath, idf, stop_words <span style="color:#b00040">string</span>) <span style="color:#666">*</span>JiebaTokenizer {
	x <span style="color:#666">:=</span> gojieba.<span style="color:#00f">NewJieba</span>(dictpath, hmmpath, userdictpath, idf, stop_words)
	<span style="color:#008000;font-weight:bold">return</span> <span style="color:#666">&amp;</span>JiebaTokenizer{x}
}

<span style="color:#008000;font-weight:bold">func</span> (x <span style="color:#666">*</span>JiebaTokenizer) <span style="color:#00f">Free</span>() {
	x.handle.<span style="color:#00f">Free</span>()
}

<span style="color:#008000;font-weight:bold">func</span> (x <span style="color:#666">*</span>JiebaTokenizer) <span style="color:#00f">Tokenize</span>(sentence []<span style="color:#b00040">byte</span>) analysis.TokenStream {
	result <span style="color:#666">:=</span> <span style="color:#008000">make</span>(analysis.TokenStream, <span style="color:#666">0</span>)
	pos <span style="color:#666">:=</span> <span style="color:#666">1</span>
	words <span style="color:#666">:=</span> x.handle.<span style="color:#00f">Tokenize</span>(<span style="color:#008000">string</span>(sentence), gojieba.SearchMode, <span style="color:#008000;font-weight:bold">false</span>)
	<span style="color:#008000;font-weight:bold">for</span> _, word <span style="color:#666">:=</span> <span style="color:#008000;font-weight:bold">range</span> words {
		token <span style="color:#666">:=</span> analysis.Token{
			Term:     []<span style="color:#008000">byte</span>(word.Str),
			Start:    word.Start,
			End:      word.End,
			Position: pos,
			Type:     analysis.Ideographic,
		}
		result = <span style="color:#008000">append</span>(result, <span style="color:#666">&amp;</span>token)
		pos<span style="color:#666">++</span>
	}
	<span style="color:#008000;font-weight:bold">return</span> result
}

<span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">tokenizerConstructor</span>(config <span style="color:#008000;font-weight:bold">map</span>[<span style="color:#b00040">string</span>]<span style="color:#008000;font-weight:bold">interface</span>{}, cache <span style="color:#666">*</span>registry.Cache) (analysis.Tokenizer, <span style="color:#b00040">error</span>) {
	dictpath, ok <span style="color:#666">:=</span> config[<span style="color:#ba2121">&#34;dictpath&#34;</span>].(<span style="color:#b00040">string</span>)
	<span style="color:#008000;font-weight:bold">if</span> !ok {
		<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">nil</span>, errors.<span style="color:#00f">New</span>(<span style="color:#ba2121">&#34;config dictpath not found&#34;</span>)
	}
	hmmpath, ok <span style="color:#666">:=</span> config[<span style="color:#ba2121">&#34;hmmpath&#34;</span>].(<span style="color:#b00040">string</span>)
	<span style="color:#008000;font-weight:bold">if</span> !ok {
		<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">nil</span>, errors.<span style="color:#00f">New</span>(<span style="color:#ba2121">&#34;config hmmpath not found&#34;</span>)
	}
	userdictpath, ok <span style="color:#666">:=</span> config[<span style="color:#ba2121">&#34;userdictpath&#34;</span>].(<span style="color:#b00040">string</span>)
	<span style="color:#008000;font-weight:bold">if</span> !ok {
		<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">nil</span>, errors.<span style="color:#00f">New</span>(<span style="color:#ba2121">&#34;config userdictpath not found&#34;</span>)
	}
	idf, ok <span style="color:#666">:=</span> config[<span style="color:#ba2121">&#34;idf&#34;</span>].(<span style="color:#b00040">string</span>)
	<span style="color:#008000;font-weight:bold">if</span> !ok {
		<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">nil</span>, errors.<span style="color:#00f">New</span>(<span style="color:#ba2121">&#34;config idf not found&#34;</span>)
	}
	stop_words, ok <span style="color:#666">:=</span> config[<span style="color:#ba2121">&#34;stop_words&#34;</span>].(<span style="color:#b00040">string</span>)
	<span style="color:#008000;font-weight:bold">if</span> !ok {
		<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">nil</span>, errors.<span style="color:#00f">New</span>(<span style="color:#ba2121">&#34;config stop_words not found&#34;</span>)
	}
	<span style="color:#008000;font-weight:bold">return</span> <span style="color:#00f">NewJiebaTokenizer</span>(dictpath, hmmpath, userdictpath, idf, stop_words), <span style="color:#008000;font-weight:bold">nil</span>
}

<span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">WithJiebaAnalyzer</span>(indexMapping <span style="color:#666">*</span>mapping.IndexMappingImpl) <span style="color:#b00040">error</span> {
	err <span style="color:#666">:=</span> indexMapping.<span style="color:#00f">AddCustomTokenizer</span>(<span style="color:#ba2121">&#34;gojieba&#34;</span>,
		<span style="color:#008000;font-weight:bold">map</span>[<span style="color:#b00040">string</span>]<span style="color:#008000;font-weight:bold">interface</span>{}{
			<span style="color:#ba2121">&#34;dictpath&#34;</span>:     gojieba.DICT_PATH,
			<span style="color:#ba2121">&#34;hmmpath&#34;</span>:      gojieba.HMM_PATH,
			<span style="color:#ba2121">&#34;userdictpath&#34;</span>: gojieba.USER_DICT_PATH,
			<span style="color:#ba2121">&#34;idf&#34;</span>:          gojieba.IDF_PATH,
			<span style="color:#ba2121">&#34;stop_words&#34;</span>:   gojieba.STOP_WORDS_PATH,
			<span style="color:#ba2121">&#34;type&#34;</span>:         <span style="color:#ba2121">&#34;gojieba&#34;</span>,
		},
	)
	<span style="color:#008000;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#008000;font-weight:bold">nil</span> {
		<span style="color:#008000;font-weight:bold">return</span> err
	}
	err = indexMapping.<span style="color:#00f">AddCustomAnalyzer</span>(<span style="color:#ba2121">&#34;gojieba&#34;</span>,
		<span style="color:#008000;font-weight:bold">map</span>[<span style="color:#b00040">string</span>]<span style="color:#008000;font-weight:bold">interface</span>{}{
			<span style="color:#ba2121">&#34;type&#34;</span>:      <span style="color:#ba2121">&#34;gojieba&#34;</span>,
			<span style="color:#ba2121">&#34;tokenizer&#34;</span>: <span style="color:#ba2121">&#34;gojieba&#34;</span>,
		},
	)
	<span style="color:#008000;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#008000;font-weight:bold">nil</span> {
		<span style="color:#008000;font-weight:bold">return</span> err
	}
	indexMapping.DefaultAnalyzer = <span style="color:#ba2121">&#34;gojieba&#34;</span>

	<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">nil</span>
}

</code></pre></div><h2 id="bleve-文档摘录">Bleve 文档摘录</h2>
<h3 id="相关术语">相关术语</h3>
<blockquote>
<p>Term（终结符），Token（令牌，又称词法单元），Text（文本）</p>
</blockquote>
<h3 id="重要接口">重要接口</h3>
<blockquote>
<p>Index（索引）</p>
</blockquote>
<p>An Index implements all the indexing and searching capabilities of bleve. An Index can be created using the New() and Open() methods.</p>
<p>Index() takes an input value, deduces a DocumentMapping for its type, assigns string paths to its fields or values then applies field mappings on them.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#008000;font-weight:bold">type</span> Index <span style="color:#008000;font-weight:bold">interface</span> {

	<span style="color:#00f">Index</span>(id <span style="color:#b00040">string</span>, data <span style="color:#008000;font-weight:bold">interface</span>{}) <span style="color:#b00040">error</span>
	<span style="color:#00f">Delete</span>(id <span style="color:#b00040">string</span>) <span style="color:#b00040">error</span>

	<span style="color:#00f">Document</span>(id <span style="color:#b00040">string</span>) (<span style="color:#666">*</span>document.Document, <span style="color:#b00040">error</span>)
	<span style="color:#00f">DocCount</span>() (<span style="color:#b00040">uint64</span>, <span style="color:#b00040">error</span>)

	<span style="color:#00f">Search</span>(req <span style="color:#666">*</span>SearchRequest) (<span style="color:#666">*</span>SearchResult, <span style="color:#b00040">error</span>)
	<span style="color:#00f">SearchInContext</span>(ctx context.Context, req <span style="color:#666">*</span>SearchRequest) (<span style="color:#666">*</span>SearchResult, <span style="color:#b00040">error</span>)

	<span style="color:#00f">Fields</span>() ([]<span style="color:#b00040">string</span>, <span style="color:#b00040">error</span>)

	<span style="color:#00f">Close</span>() <span style="color:#b00040">error</span>

	<span style="color:#00f">Mapping</span>() mapping.IndexMapping

	<span style="color:#00f">Stats</span>() <span style="color:#666">*</span>IndexStat
	<span style="color:#00f">StatsMap</span>() <span style="color:#008000;font-weight:bold">map</span>[<span style="color:#b00040">string</span>]<span style="color:#008000;font-weight:bold">interface</span>{}

	<span style="color:#00f">Name</span>() <span style="color:#b00040">string</span>
	<span style="color:#00f">SetName</span>(<span style="color:#b00040">string</span>)
}

</code></pre></div><blockquote>
<p>IndexMapping（索引映射模式）</p>
</blockquote>
<p>An IndexMappingImpl controls how objects are placed into an index. First the type of the object is determined. Once the type is know, the appropriate DocumentMapping is selected by the type. If no mapping was determined for that type, a DefaultMapping will be used.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#008000;font-weight:bold">type</span> IndexMapping <span style="color:#008000;font-weight:bold">interface</span> {
	<span style="color:#00f">MapDocument</span>(doc <span style="color:#666">*</span>document.Document, data <span style="color:#008000;font-weight:bold">interface</span>{}) <span style="color:#b00040">error</span>
	<span style="color:#00f">Validate</span>() <span style="color:#b00040">error</span>

	<span style="color:#00f">DateTimeParserNamed</span>(name <span style="color:#b00040">string</span>) analysis.DateTimeParser

	<span style="color:#00f">DefaultSearchField</span>() <span style="color:#b00040">string</span>

	<span style="color:#00f">AnalyzerNameForPath</span>(path <span style="color:#b00040">string</span>) <span style="color:#b00040">string</span>
	<span style="color:#00f">AnalyzerNamed</span>(name <span style="color:#b00040">string</span>) <span style="color:#666">*</span>analysis.Analyzer
}

<span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">NewIndexMapping</span>() <span style="color:#666">*</span>IndexMappingImpl

</code></pre></div><blockquote>
<p>Search（搜索）</p>
</blockquote>
<p>A SearchRequest describes all the parameters needed to search the index. Query is required. Size/From describe how much and which part of the result set to return. Highlight describes optional search result highlighting. Fields describes a list of field values which should be retrieved for result documents, provided they were stored while indexing. Facets describe the set of facets to be computed. Explain triggers inclusion of additional search result score explanations. Sort describes the desired order for the results to be returned. Score controls the kind of scoring performed SearchAfter supports deep paging by providing a minimum sort key SearchBefore supports deep paging by providing a maximum sort key.</p>
<blockquote>
<p>Result（搜索结果）</p>
</blockquote>
<p>A SearchResult describes the results of executing a SearchRequest.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#008000;font-weight:bold">type</span> SearchResult <span style="color:#008000;font-weight:bold">struct</span> {
	Status   <span style="color:#666">*</span>SearchStatus                  <span style="color:#ba2121">`json:&#34;status&#34;`</span>
	Request  <span style="color:#666">*</span>SearchRequest                 <span style="color:#ba2121">`json:&#34;request&#34;`</span>
	Hits     search.DocumentMatchCollection <span style="color:#ba2121">`json:&#34;hits&#34;`</span>
	Total    <span style="color:#b00040">uint64</span>                         <span style="color:#ba2121">`json:&#34;total_hits&#34;`</span>
	MaxScore <span style="color:#b00040">float64</span>                        <span style="color:#ba2121">`json:&#34;max_score&#34;`</span>
	Took     time.Duration                  <span style="color:#ba2121">`json:&#34;took&#34;`</span>
	Facets   search.FacetResults            <span style="color:#ba2121">`json:&#34;facets&#34;`</span>
}

</code></pre></div><h3 id="查询方法">查询方法</h3>
<p>Bleve 支持以下查询方法：</p>
<ul>
<li>Term（单词精确匹配）</li>
<li>Match（单词全文匹配）</li>
<li>Phrase（短语精确匹配）</li>
<li>Phrase Match（短语全文匹配）</li>
<li>Prefix（前缀匹配）</li>
<li>Fuzzy（模糊匹配）</li>
<li>Conjunction（并匹配）</li>
<li>Disjunction（或匹配）</li>
<li>Boolean（条件匹配）</li>
<li>Numberic Range（数据区间匹配）</li>
<li>Date Range（时间区间匹配）</li>
<li>Query String（查询语句）</li>
<li>Match All（全部返回）</li>
<li>Match None（全部丢弃）</li>
<li>Doc ID（ID 匹配）</li>
</ul>
<blockquote>
<p>查询语句格式</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
field: [&gt;,<span style="color:#666">&gt;=</span>,&lt;,<span style="color:#666">&lt;=</span>][term]

</code></pre></div><h3 id="结果排序">结果排序</h3>
<p>The default behavior is to sort results by relevance, with the highest scoring results first. For example below, this will first sort results by the “age” field. If two documents have the same value for this field, they will then be sorted by the score descending, finally, if documents have the same age and score, they will be sorted by document ID ascending.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
searchRequest.<span style="color:#00f">SortBy</span>([]<span style="color:#b00040">string</span>{<span style="color:#ba2121">&#34;age&#34;</span>, <span style="color:#ba2121">&#34;-_score&#34;</span>, <span style="color:#ba2121">&#34;_id&#34;</span>})

</code></pre></div><h3 id="联合搜索">联合搜索</h3>
<blockquote>
<p>IndexAlias（索引集）</p>
</blockquote>
<p>Bleve has a powerful feature called an IndexAlias. The IndexAlias can be used to search an index, with the additional ability to atomically switch the underlying physical index. IndexAliases can also be used to search across multiple indexes at the same time and correctly merge the results.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#008000;font-weight:bold">type</span> IndexAlias <span style="color:#008000;font-weight:bold">interface</span> {
	Index

	<span style="color:#00f">Add</span>(i <span style="color:#666">...</span>Index)
	<span style="color:#00f">Remove</span>(i <span style="color:#666">...</span>Index)
	<span style="color:#00f">Swap</span>(in, out []Index)
}


</code></pre></div><h3 id="facet聚合">Facet（聚合）</h3>
<p>Facets allow you to include aggregated information about the documents matching your query.</p>
<h2 id="bleve-实践一">Bleve 实践一</h2>
<h3 id="创建索引数据库">创建索引数据库</h3>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://blog.couchbase.com/full-text_search_text_analysis/">https://blog.couchbase.com/full-text_search_text_analysis/</a></li>
<li><a href="https://blog.jln.co/Go-Bleve-%E8%87%AA%E5%B8%B6%E5%85%A8%E6%96%87%E6%90%9C%E5%B0%8B/">https://blog.jln.co/Go-Bleve-%E8%87%AA%E5%B8%B6%E5%85%A8%E6%96%87%E6%90%9C%E5%B0%8B/</a></li>
<li><a href="https://github.com/yanyiwu/gojieba">https://github.com/yanyiwu/gojieba</a></li>
<li><a href="https://github.com/ttys3/gojieba-bleve/blob/master/bleve_test.go">https://github.com/ttys3/gojieba-bleve/blob/master/bleve_test.go</a></li>
<li><a href="http://blevesearch.com/docs/Home/">http://blevesearch.com/docs/Home/</a></li>
<li><a href="https://github.com/blevesearch/beer-search">https://github.com/blevesearch/beer-search</a></li>
<li><a href="https://github.com/blevesearch/bleve-explorer">https://github.com/blevesearch/bleve-explorer</a></li>
<li><a href="https://github.com/practice-golang/bleve/blob/master/map/map.go">https://github.com/practice-golang/bleve/blob/master/map/map.go</a></li>
</ul>
        </article>
        

      </main>

      <nav class="end-nav">
        
        <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://taodanfang.github.io/posts/nats-io-2/" class="card blog-card" rel="bookmark" >
  
  <div class="card-img-container">
    <p class="card-img-overlay">下一篇</p>
    <picture>
      
      
      
      <source srcset="https://taodanfang.github.io/posts/nats-io-2/media/16396294181403_hubaae0ff782c8b75f8b806f4834290463_247132_400x0_resize_q75_lanczos.jpg 1x, https://taodanfang.github.io/posts/nats-io-2/media/16396294181403_hubaae0ff782c8b75f8b806f4834290463_247132_800x0_resize_q75_lanczos.jpg 2x, https://taodanfang.github.io/posts/nats-io-2/media/16396294181403_hubaae0ff782c8b75f8b806f4834290463_247132_1200x0_resize_q75_lanczos.jpg 3x">
      <img src="https://taodanfang.github.io/posts/nats-io-2/media/16396294181403_hubaae0ff782c8b75f8b806f4834290463_247132_400x0_resize_q75_lanczos.jpg" class="card-img" >
    </picture>
  </div>
  
  <article class="card-body">
    <h2 class="card-title">NATS 开发文档摘录</h2>
    <p class="card-text">本文摘录了NATS官方文档中的重要部分。包括：基本的nats使用，支持持久化的jetstream的使用方法。
</p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2021-12-13 1213:00">Dec 13, 2021</time></p>
      <p>#golang #nats </p>
    </div>
  </article>
</a>
        
      </nav>

      
        <script src="https://utteranc.es/client.js"
        repo="taodanfang/hugoblogtalks"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
        </script>
      

  </div>

  <footer>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</footer>
  
  <script defer src="https://taodanfang.github.io/js/katex.js"></script>


  <script defer src="https://taodanfang.github.io/js/auto-render.js" onload="renderMathInElement(document.body);"></script>


<script src="https://taodanfang.github.io/js/core.min.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

  <script>
    $('#TableOfContents a').click(function () {
      console.log("click");
    var target = $(this).attr('href');
    console.log(target);
    $('html, body').animate({
       scrollTop: $(target).offset().top - 108 
     }, 500);
     return false;
    });
    $('body > div:nth-child(1) > nav > h3 > a').click(function () {
      console.log("click");
    var target = $(this).attr('href');
    console.log(target);
    $('html, body').animate({
       scrollTop: $(target).offset().top - 108 
     }, 500);
     return false;
    });
  </script>
  </body>
</html>
